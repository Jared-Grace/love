import { app_replace_button_symbol_style_invalid } from "../../../love/public/src/app_replace_button_symbol_style_invalid.mjs";
import { html_style_padding_em } from "../../../love/public/src/html_style_padding_em.mjs";
import { app_replace_button_screen } from "../../../love/public/src/app_replace_button_screen.mjs";
import { storage_local_transform_empty_context } from "../../../love/public/src/storage_local_transform_empty_context.mjs";
import { app_replace_button_symbol_style_valid_multiple } from "../../../love/public/src/app_replace_button_symbol_style_valid_multiple.mjs";
import { app_replace_button_symbol_style_inner } from "../../../love/public/src/app_replace_button_symbol_style_inner.mjs";
import { list_map_html_bounding_client_rect } from "../../../love/public/src/list_map_html_bounding_client_rect.mjs";
import { html_translation_transition_clear } from "../../../love/public/src/html_translation_transition_clear.mjs";
import { html_display_inline_block_multiple } from "../../../love/public/src/html_display_inline_block_multiple.mjs";
import { html_display_none_multiple } from "../../../love/public/src/html_display_none_multiple.mjs";
import { html_move_animate_multiple } from "../../../love/public/src/html_move_animate_multiple.mjs";
import { html_parent_append_multiple } from "../../../love/public/src/html_parent_append_multiple.mjs";
import { html_move_animate_multiple_parent_remove } from "../../../love/public/src/html_move_animate_multiple_parent_remove.mjs";
import { html_move_animate_translate } from "../../../love/public/src/html_move_animate_translate.mjs";
import { html_move_animate_rect } from "../../../love/public/src/html_move_animate_rect.mjs";
import { lists_map } from "../../../love/public/src/lists_map.mjs";
import { sleep } from "../../../love/public/src/sleep.mjs";
import { html_request_animation_frame } from "../../../love/public/src/html_request_animation_frame.mjs";
import { html_bounding_client_rect } from "../../../love/public/src/html_bounding_client_rect.mjs";
import { html_visibility_hidden } from "../../../love/public/src/html_visibility_hidden.mjs";
import { html_insert } from "../../../love/public/src/html_insert.mjs";
import { html_clone } from "../../../love/public/src/html_clone.mjs";
import { list_wait } from "../../../love/public/src/list_wait.mjs";
import { list_slice_count } from "../../../love/public/src/list_slice_count.mjs";
import { log } from "../../../love/public/src/log.mjs";
import { property_exists } from "../../../love/public/src/property_exists.mjs";
import { html_p_text_centered } from "../../../love/public/src/html_p_text_centered.mjs";
import { app_replace_rule_sets } from "../../../love/public/src/app_replace_rule_sets.mjs";
import { app_replace_button_home } from "../../../love/public/src/app_replace_button_home.mjs";
import { html_width_full } from "../../../love/public/src/html_width_full.mjs";
import { storage_local_set_context } from "../../../love/public/src/storage_local_set_context.mjs";
import { list_index_is } from "../../../love/public/src/list_index_is.mjs";
import { app_karate_button_next_text } from "../../../love/public/src/app_karate_button_next_text.mjs";
import { app_replace_rule_sets_data_goal } from "../../../love/public/src/app_replace_rule_sets_data_goal.mjs";
import { property_set } from "../../../love/public/src/property_set.mjs";
import { html_bold } from "../../../love/public/src/html_bold.mjs";
import { html_style_font_size } from "../../../love/public/src/html_style_font_size.mjs";
import { html_centered } from "../../../love/public/src/html_centered.mjs";
import { list_add_first } from "../../../love/public/src/list_add_first.mjs";
import { list_join_empty } from "../../../love/public/src/list_join_empty.mjs";
import { invoke } from "../../../love/public/src/invoke.mjs";
import { list_shuffle_take } from "../../../love/public/src/list_shuffle_take.mjs";
import { emoji_party_face } from "../../../love/public/src/emoji_party_face.mjs";
import { emoji_party_popper } from "../../../love/public/src/emoji_party_popper.mjs";
import { emoji_clap } from "../../../love/public/src/emoji_clap.mjs";
import { emoji_100 } from "../../../love/public/src/emoji_100.mjs";
import { emoji_medal_star } from "../../../love/public/src/emoji_medal_star.mjs";
import { emoji_medal_1 } from "../../../love/public/src/emoji_medal_1.mjs";
import { emoji_trophy } from "../../../love/public/src/emoji_trophy.mjs";
import { emoji_check } from "../../../love/public/src/emoji_check.mjs";
import { html_span_text } from "../../../love/public/src/html_span_text.mjs";
import { json_equal } from "../../../love/public/src/json_equal.mjs";
import { each } from "../../../love/public/src/each.mjs";
import { app_replace_button_symbol_style_valid_curry_right } from "../../../love/public/src/app_replace_button_symbol_style_valid_curry_right.mjs";
import { app_replace_button_side } from "../../../love/public/src/app_replace_button_side.mjs";
import { app_replace_goals } from "../../../love/public/src/app_replace_goals.mjs";
import { app_shared_screen_set } from "../../../love/public/src/app_shared_screen_set.mjs";
import { app_replace_button } from "../../../love/public/src/app_replace_button.mjs";
import { app_replace_lefts_rights_style } from "../../../love/public/src/app_replace_lefts_rights_style.mjs";
import { storage_local_get_context } from "../../../love/public/src/storage_local_get_context.mjs";
import { app_replace_button_rule } from "../../../love/public/src/app_replace_button_rule.mjs";
import { app_replace_rule_set_get } from "../../../love/public/src/app_replace_rule_set_get.mjs";
import { ternary } from "../../../love/public/src/ternary.mjs";
import { app_replace_button_rule_background_color } from "../../../love/public/src/app_replace_button_rule_background_color.mjs";
import { app_replace_rule_set_highlight } from "../../../love/public/src/app_replace_rule_set_highlight.mjs";
import { html_style_font_color_set_if } from "../../../love/public/src/html_style_font_color_set_if.mjs";
import { ternary_nested } from "../../../love/public/src/ternary_nested.mjs";
import { html_style_background_color_set } from "../../../love/public/src/html_style_background_color_set.mjs";
import { app_replace_button_symbol_style_valid } from "../../../love/public/src/app_replace_button_symbol_style_valid.mjs";
import { app_replace_rule_valid_curry } from "../../../love/public/src/app_replace_rule_valid_curry.mjs";
import { app_replace_button_symbol_style } from "../../../love/public/src/app_replace_button_symbol_style.mjs";
import { property_set_exists_not } from "../../../love/public/src/property_set_exists_not.mjs";
import { range } from "../../../love/public/src/range.mjs";
import { list_any } from "../../../love/public/src/list_any.mjs";
import { html_div } from "../../../love/public/src/html_div.mjs";
import { list_concat_multiple } from "../../../love/public/src/list_concat_multiple.mjs";
import { list_size } from "../../../love/public/src/list_size.mjs";
import { list_skip } from "../../../love/public/src/list_skip.mjs";
import { object_merge } from "../../../love/public/src/object_merge.mjs";
import { app_replace_rule_valid } from "../../../love/public/src/app_replace_rule_valid.mjs";
import { not } from "../../../love/public/src/not.mjs";
import { html_enable_if } from "../../../love/public/src/html_enable_if.mjs";
import { html_text_set_if } from "../../../love/public/src/html_text_set_if.mjs";
import { null_not_is } from "../../../love/public/src/null_not_is.mjs";
import { each_index } from "../../../love/public/src/each_index.mjs";
import { list_map_index } from "../../../love/public/src/list_map_index.mjs";
import { html_p } from "../../../love/public/src/html_p.mjs";
import { html_disable } from "../../../love/public/src/html_disable.mjs";
import { text_split_empty } from "../../../love/public/src/text_split_empty.mjs";
import { storage_local_initialize_context } from "../../../love/public/src/storage_local_initialize_context.mjs";
import { property_get } from "../../../love/public/src/property_get.mjs";
import { html_button } from "../../../love/public/src/html_button.mjs";
import { app_replace_rule_parse } from "../../../love/public/src/app_replace_rule_parse.mjs";
import { list_map } from "../../../love/public/src/list_map.mjs";
import { html_p_text } from "../../../love/public/src/html_p_text.mjs";
import { list_get } from "../../../love/public/src/list_get.mjs";
import { list_take } from "../../../love/public/src/list_take.mjs";
import { html_clear } from "../../../love/public/src/html_clear.mjs";
export async function app_replace_rule_set(context) {
  let root = property_get(context, "root");
  app_replace_button_home(root, context);
  app_replace_button_screen(context, app_replace_goals, root, "Goals");
  app_replace_button_screen(context, app_replace_rule_set, root, "Start over");
  let rule = app_replace_rule_set_get(context);
  let rule_name = property_get(rule, "name");
  html_p_text(root, "Rule set: " + rule_name);
  let goal_index = storage_local_get_context(context, "goal_index");
  let goals = property_get(rule, "goals");
  let goal = list_get(goals, goal_index);
  let start = property_get(goal, "start");
  if (false) {
    ("not sure if this is needed or not");
    let current = storage_local_initialize_context(
      context,
      "rule_set_start",
      start,
    );
  }
  let index_selected = null;
  let label_rules = html_p(root);
  let rules = property_get(rule, "rules");
  let rules_parsed = list_map(rules, app_replace_rule_parse);
  let symbols_invalid_chosen = {};
  let div_rules_buttons = html_div(root);
  let label_symbols = html_p(root);
  let div_refresh = html_div(root);
  let current_list = text_split_empty(start);
  let label_goal = html_p_text(root, "Goal:");
  let end = property_get(goal, "end");
  let goal_list = text_split_empty(end);
  let p_goal = html_p(root);
  let goal_list_symbols = app_replace_button_side(p_goal, goal_list);
  let lambda4 = app_replace_button_symbol_style_valid_curry_right(false);
  each(goal_list_symbols, lambda4);
  let highlight = app_replace_rule_set_highlight();
  let div_below = html_div(root);
  let success = false;
  const duration = 555;
  refresh();
  async function refresh() {
    html_clear(div_rules_buttons);
    function each_rule(rule, index) {
      let left = property_get(rule, "left");
      let right = property_get(rule, "right");
      function lambda3() {
        symbols_invalid_chosen = {};
        index_selected = ternary(index_selected === index, null, index);
        refresh();
        return;
      }
      let r2 = app_replace_button_rule(div_rules_buttons, left, right, lambda3);
      let arrow = property_get(r2, "arrow");
      let rights = property_get(r2, "rights");
      let lefts = property_get(r2, "lefts");
      let rb = property_get(r2, "b");
      html_disable(rb);
      object_merge(rb, {
        rule,
        lefts,
        rights,
        arrow,
      });
      return rb;
    }
    let rules_buttons = list_map_index(rules_parsed, each_rule);
    function each_button_rule_refresh(rb, index2) {
      let rule2 = property_get(rb, "rule");
      let size2 = list_size(current_list);
      let r = range(size2);
      let lambda7 = app_replace_rule_valid_curry(rule2, current_list);
      let enabled = list_any(r, lambda7);
      const selected = index2 === index_selected;
      enabled = index_selected === null || selected;
      enabled = true;
      html_enable_if(rb, enabled);
      app_replace_lefts_rights_style(rb, enabled);
      let on_b = app_replace_button_rule_background_color();
      let c = ternary_nested(selected, highlight, enabled, on_b, "#a8a8a8ff");
      html_style_background_color_set(rb, c);
      let arrow2 = property_get(rb, "arrow");
      html_style_font_color_set_if(enabled, arrow2, "black", "#6a6a6a");
    }
    each_index(rules_buttons, each_button_rule_refresh);
    html_clear(div_refresh);
    let div_symbols = html_div(div_refresh);
    let sbs = null;
    function symbols_mapper(symbol, index) {
      let sb = null;
      async function symbol_on_click() {
        let rule2 = list_get(rules_parsed, index_selected);
        let eq = app_replace_rule_valid(rule2, index, current_list);
        if (eq) {
          symbols_invalid_chosen = {};
          let right = property_get(rule2, "right");
          let left = property_get(rule2, "left");
          let before = list_take(current_list, index);
          let size = list_size(left);
          let after = list_skip(current_list, index + size);
          current_list = list_concat_multiple([before, right, after]);
          let rb = list_get(rules_buttons, index_selected);
          let lefts2 = property_get(rb, "lefts");
          let rights2 = property_get(rb, "rights");
          let size3 = list_size(lefts2);
          let sliced2 = list_slice_count(sbs, index, size3);
          const sum = index + size3;
          let skipped = list_skip(sbs, sum);
          let rects_before = list_map(skipped, html_bounding_client_rect);
          await html_move_animate_multiple_parent_remove(
            sliced2,
            lefts2,
            duration,
          );
          await html_request_animation_frame();
          let rights_cloned = list_map(rights2, html_clone);
          function lambda8(item, index5) {
            html_visibility_hidden(item);
            html_insert(div_symbols, item, index + index5);
          }
          each_index(rights_cloned, lambda8);
          let rects_after = list_map(skipped, html_bounding_client_rect);
          async function lambda9([el, rect_before, rect_after]) {
            await html_move_animate_rect(el, rect_before, rect_after, 0);
            el.offsetWidth;
            await html_request_animation_frame();
            await html_move_animate_translate(el, 0, 0, duration);
            await sleep(duration);
            html_translation_transition_clear(el);
          }
          let mapped2 = lists_map(
            [skipped, rects_after, rects_before],
            lambda9,
          );
          await list_wait(mapped2);
          await html_move_animate_multiple(rights2, rights_cloned, duration);
          if (false) {
            let rights_cloneds2 = list_map(rights2, html_clone);
            html_display_none_multiple(rights_cloneds2);
            html_parent_append_multiple(div_refresh, rights_cloneds2);
            html_display_inline_block_multiple(rights_cloneds2);
            let rights_cloned2_rects =
              list_map_html_bounding_client_rect(rights_cloneds2);
            let rights2_rects = list_map_html_bounding_client_rect(rights2);
            return;
            async function lambda6([
              rights_cloned2,
              rights_cloned2_rect,
              rights2_rect,
            ]) {
              await html_move_animate_rect(
                rights_cloned2,
                rights_cloned2_rect,
                rights2_rect,
                duration,
              );
            }
            let mapped3 = lists_map(
              [rights_cloneds2, rights_cloned2_rects, rights2_rects],
              lambda6,
            );
            await list_wait(mapped3);
            log({
              rights_cloned2: rights_cloneds2,
            });
            return;
            await html_move_animate_multiple(
              rights_cloneds2,
              rights_cloned,
              duration,
            );
          }
          index_selected = null;
        } else {
          property_set(symbols_invalid_chosen, index, true);
        }
        refresh();
      }
      sb = html_button(div_symbols, symbol, symbol_on_click);
      app_replace_button_symbol_style(sb);
      property_set_exists_not(sb, "index", index);
      let valid = false;
      let nn2 = null_not_is(index_selected);
      if (nn2) {
        let index3 = property_get(sb, "index");
        let rule2 = list_get(rules_parsed, index_selected);
        valid = app_replace_rule_valid(rule2, index3, current_list);
      }
      app_replace_button_symbol_style_valid(sb, index_selected !== null);
      let exists = property_exists(symbols_invalid_chosen, index);
      if (exists) {
        app_replace_button_symbol_style_invalid(sb);
      }
      return sb;
    }
    sbs = list_map_index(current_list, symbols_mapper);
    ("no success yet?");
    if (not(success)) {
      ("goal satisfied?");
      let eq2 = json_equal(current_list, goal_list);
      if (eq2) {
        success = true;
        function lambda5(value) {
          let g = app_replace_rule_sets_data_goal(value, rule_name, goal);
          property_set(g, "completed", true);
          return value;
        }
        storage_local_transform_empty_context(
          context,
          "rule_sets_data",
          lambda5,
        );
        const list = [goal_list_symbols, sbs];
        app_replace_button_symbol_style_valid_multiple(list, true);
        await html_move_animate_multiple(sbs, goal_list_symbols, duration);
        symbols_hide_on_success();
        let choices = [
          emoji_trophy,
          emoji_100,
          emoji_clap,
          emoji_medal_star,
          emoji_medal_1,
          emoji_party_popper,
          emoji_party_face,
        ];
        const taken_count = 3;
        let taken = list_shuffle_take(choices, taken_count);
        list_add_first(taken, emoji_check);
        let mapped = list_map(taken, invoke);
        let joined = list_join_empty(mapped);
        let p = html_p(div_below);
        html_style_background_color_set(p, highlight);
        app_replace_button_symbol_style_inner(p);
        const value_em = "0.3";
        html_style_padding_em(p, value_em);
        html_centered(p);
        let p_emojis = html_div(p);
        html_span_text(p_emojis, joined);
        html_style_font_size(p_emojis, "1.5em");
        let p_encouragement = html_div(p);
        const encouragements_choices = [
          "Congratulations",
          "Success",
          "Good job",
          "Great job",
          "Well done",
          "Keep it up",
          "Amazing",
        ];
        let encouragements = list_shuffle_take(encouragements_choices, 2);
        html_bold(p_encouragement);
        function lambda(encouragement) {
          html_span_text(p_encouragement, encouragement + "! ");
        }
        each(encouragements, lambda);
        let p_next = html_p(div_below);
        let goal_index_next = goal_index + 1;
        let ii = list_index_is(goals, goal_index_next);
        let rule_set_index = storage_local_get_context(
          context,
          "rule_set_index",
        );
        let rule_sets = app_replace_rule_sets();
        let rule_set_index_next = rule_set_index + 1;
        let ii2 = list_index_is(rule_sets, rule_set_index_next);
        let next = true;
        if (not(ii) && not(ii2)) {
          html_p_text_centered(
            p_next,
            "You have completed all goals that are available at this time!",
          );
        }
        function lambda2() {
          if (ii) {
            storage_local_set_context(context, "goal_index", goal_index_next);
          } else {
            if (ii2) {
              storage_local_set_context(
                context,
                "rule_set_index",
                rule_set_index_next,
              );
              storage_local_set_context(context, "goal_index", 0);
            } else {
              next = false;
            }
          }
          app_shared_screen_set(context, app_replace_rule_set);
        }
        let text = app_karate_button_next_text();
        let bn = app_replace_button(p_next, text, lambda2);
        html_width_full(bn);
      }
      let nn = null_not_is(index_selected);
      html_text_set_if(nn, "Rules:", "Choose a rule:", label_rules);
      html_text_set_if(nn, "Choose a symbol:", "Symbols:", label_symbols);
    }
    if (success) {
      symbols_hide_on_success();
      return;
    }
    function symbols_hide_on_success() {
      html_visibility_hidden(div_symbols);
    }
  }
  refresh();
}
