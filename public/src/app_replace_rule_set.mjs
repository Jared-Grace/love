import { sleep } from "../../../love/public/src/sleep.mjs";
import { html_request_animation_frame } from "../../../love/public/src/html_request_animation_frame.mjs";
import { html_style_set } from "../../../love/public/src/html_style_set.mjs";
import { each_multiple_async } from "../../../love/public/src/each_multiple_async.mjs";
import { html_move_animate_rect } from "../../../love/public/src/html_move_animate_rect.mjs";
import { html_bounding_client_rect } from "../../../love/public/src/html_bounding_client_rect.mjs";
import { html_parent_remove } from "../../../love/public/src/html_parent_remove.mjs";
import { html_visibility_hidden } from "../../../love/public/src/html_visibility_hidden.mjs";
import { html_insert } from "../../../love/public/src/html_insert.mjs";
import { html_clone } from "../../../love/public/src/html_clone.mjs";
import { list_wait } from "../../../love/public/src/list_wait.mjs";
import { list_map_pairs } from "../../../love/public/src/list_map_pairs.mjs";
import { list_slice_count } from "../../../love/public/src/list_slice_count.mjs";
import { html_move_animate } from "../../../love/public/src/html_move_animate.mjs";
import { app_replace_button_symbol_style_box_shadow } from "../../../love/public/src/app_replace_button_symbol_style_box_shadow.mjs";
import { log } from "../../../love/public/src/log.mjs";
import { property_exists } from "../../../love/public/src/property_exists.mjs";
import { html_p_text_centered } from "../../../love/public/src/html_p_text_centered.mjs";
import { app_replace_rule_sets } from "../../../love/public/src/app_replace_rule_sets.mjs";
import { app_replace_button_home } from "../../../love/public/src/app_replace_button_home.mjs";
import { html_width_full } from "../../../love/public/src/html_width_full.mjs";
import { storage_local_set_context } from "../../../love/public/src/storage_local_set_context.mjs";
import { list_index_is } from "../../../love/public/src/list_index_is.mjs";
import { app_karate_button_next_text } from "../../../love/public/src/app_karate_button_next_text.mjs";
import { app_replace_rule_sets_data_goal } from "../../../love/public/src/app_replace_rule_sets_data_goal.mjs";
import { property_set } from "../../../love/public/src/property_set.mjs";
import { storage_local_transform_context } from "../../../love/public/src/storage_local_transform_context.mjs";
import { html_bold } from "../../../love/public/src/html_bold.mjs";
import { html_style_font_size } from "../../../love/public/src/html_style_font_size.mjs";
import { html_centered } from "../../../love/public/src/html_centered.mjs";
import { list_add_first } from "../../../love/public/src/list_add_first.mjs";
import { list_join_empty } from "../../../love/public/src/list_join_empty.mjs";
import { invoke } from "../../../love/public/src/invoke.mjs";
import { list_shuffle_take } from "../../../love/public/src/list_shuffle_take.mjs";
import { emoji_party_face } from "../../../love/public/src/emoji_party_face.mjs";
import { emoji_party_popper } from "../../../love/public/src/emoji_party_popper.mjs";
import { emoji_clap } from "../../../love/public/src/emoji_clap.mjs";
import { emoji_100 } from "../../../love/public/src/emoji_100.mjs";
import { emoji_medal_star } from "../../../love/public/src/emoji_medal_star.mjs";
import { emoji_medal_1 } from "../../../love/public/src/emoji_medal_1.mjs";
import { emoji_trophy } from "../../../love/public/src/emoji_trophy.mjs";
import { emoji_check } from "../../../love/public/src/emoji_check.mjs";
import { html_span_text } from "../../../love/public/src/html_span_text.mjs";
import { each_nested } from "../../../love/public/src/each_nested.mjs";
import { json_equal } from "../../../love/public/src/json_equal.mjs";
import { each } from "../../../love/public/src/each.mjs";
import { app_replace_button_symbol_style_valid_curry_right } from "../../../love/public/src/app_replace_button_symbol_style_valid_curry_right.mjs";
import { app_replace_button_side } from "../../../love/public/src/app_replace_button_side.mjs";
import { app_replace_goals } from "../../../love/public/src/app_replace_goals.mjs";
import { app_shared_screen_set } from "../../../love/public/src/app_shared_screen_set.mjs";
import { app_replace_button } from "../../../love/public/src/app_replace_button.mjs";
import { app_replace_lefts_rights_style } from "../../../love/public/src/app_replace_lefts_rights_style.mjs";
import { storage_local_get_context } from "../../../love/public/src/storage_local_get_context.mjs";
import { app_replace_button_rule } from "../../../love/public/src/app_replace_button_rule.mjs";
import { app_replace_rule_set_get } from "../../../love/public/src/app_replace_rule_set_get.mjs";
import { ternary } from "../../../love/public/src/ternary.mjs";
import { app_replace_button_rule_background_color } from "../../../love/public/src/app_replace_button_rule_background_color.mjs";
import { app_replace_rule_set_highlight } from "../../../love/public/src/app_replace_rule_set_highlight.mjs";
import { html_style_font_color_set_if } from "../../../love/public/src/html_style_font_color_set_if.mjs";
import { ternary_nested } from "../../../love/public/src/ternary_nested.mjs";
import { html_style_background_color_set } from "../../../love/public/src/html_style_background_color_set.mjs";
import { app_replace_button_symbol_style_valid } from "../../../love/public/src/app_replace_button_symbol_style_valid.mjs";
import { app_replace_rule_valid_curry } from "../../../love/public/src/app_replace_rule_valid_curry.mjs";
import { app_replace_button_symbol_style } from "../../../love/public/src/app_replace_button_symbol_style.mjs";
import { property_set_exists_not } from "../../../love/public/src/property_set_exists_not.mjs";
import { range } from "../../../love/public/src/range.mjs";
import { list_any } from "../../../love/public/src/list_any.mjs";
import { html_div } from "../../../love/public/src/html_div.mjs";
import { list_concat_multiple } from "../../../love/public/src/list_concat_multiple.mjs";
import { list_size } from "../../../love/public/src/list_size.mjs";
import { list_skip } from "../../../love/public/src/list_skip.mjs";
import { object_merge } from "../../../love/public/src/object_merge.mjs";
import { app_replace_rule_valid } from "../../../love/public/src/app_replace_rule_valid.mjs";
import { not } from "../../../love/public/src/not.mjs";
import { html_enable_if } from "../../../love/public/src/html_enable_if.mjs";
import { html_text_set_if } from "../../../love/public/src/html_text_set_if.mjs";
import { null_not_is } from "../../../love/public/src/null_not_is.mjs";
import { each_index } from "../../../love/public/src/each_index.mjs";
import { list_map_index } from "../../../love/public/src/list_map_index.mjs";
import { html_p } from "../../../love/public/src/html_p.mjs";
import { html_disable } from "../../../love/public/src/html_disable.mjs";
import { text_split_empty } from "../../../love/public/src/text_split_empty.mjs";
import { storage_local_initialize_context } from "../../../love/public/src/storage_local_initialize_context.mjs";
import { property_get } from "../../../love/public/src/property_get.mjs";
import { html_button } from "../../../love/public/src/html_button.mjs";
import { app_replace_rule_parse } from "../../../love/public/src/app_replace_rule_parse.mjs";
import { list_map } from "../../../love/public/src/list_map.mjs";
import { html_p_text } from "../../../love/public/src/html_p_text.mjs";
import { list_get } from "../../../love/public/src/list_get.mjs";
import { list_take } from "../../../love/public/src/list_take.mjs";
import { html_clear } from "../../../love/public/src/html_clear.mjs";
export async function app_replace_rule_set(context) {
  let root = property_get(context, "root");
  app_replace_button_home(root, context);
  function lambda2() {
    app_shared_screen_set(context, app_replace_goals);
  }
  let b2 = app_replace_button(root, "Goals", lambda2);
  let rule = app_replace_rule_set_get(context);
  let rule_name = property_get(rule, "name");
  html_p_text(root, "Rule set: " + rule_name);
  let goal_index = storage_local_get_context(context, "goal_index");
  let goals = property_get(rule, "goals");
  let goal = list_get(goals, goal_index);
  let start = property_get(goal, "start");
  if (false) {
    ("not sure if this is needed or not");
    let current = storage_local_initialize_context(
      context,
      "rule_set_start",
      start,
    );
  }
  let index_selected = null;
  let label_rules = html_p(root);
  let rules = property_get(rule, "rules");
  let rules_parsed = list_map(rules, app_replace_rule_parse);
  let symbols_invalid_chosen = {};
  function each_rule(rule, index) {
    let left = property_get(rule, "left");
    let right = property_get(rule, "right");
    function lambda3() {
      symbols_invalid_chosen = {};
      index_selected = ternary(index_selected === index, null, index);
      refresh();
      return;
    }
    let r2 = app_replace_button_rule(root, left, right, lambda3);
    let arrow = property_get(r2, "arrow");
    let rights = property_get(r2, "rights");
    let lefts = property_get(r2, "lefts");
    let rb = property_get(r2, "b");
    html_disable(rb);
    object_merge(rb, {
      rule,
      lefts,
      rights,
      arrow,
    });
    return rb;
  }
  let rules_buttons = list_map_index(rules_parsed, each_rule);
  let label_symbols = html_p(root);
  let div_symbols = html_div(root);
  let current_list = text_split_empty(start);
  let label_goal = html_p_text(root, "Goal:");
  let end = property_get(goal, "end");
  let goal_list = text_split_empty(end);
  let p_goal = html_p(root);
  let goal_list_symbols = app_replace_button_side(p_goal, goal_list);
  let lambda4 = app_replace_button_symbol_style_valid_curry_right(false);
  each(goal_list_symbols, lambda4);
  let highlight = app_replace_rule_set_highlight();
  let div_below = html_div(root);
  let success = false;
  refresh();
  function refresh() {
    function each_button_rule_refresh(rb, index2) {
      let rule2 = property_get(rb, "rule");
      let size2 = list_size(current_list);
      let r = range(size2);
      let lambda7 = app_replace_rule_valid_curry(rule2, current_list);
      let enabled = list_any(r, lambda7);
      const selected = index2 === index_selected;
      enabled = index_selected === null || selected;
      enabled = true;
      html_enable_if(rb, enabled);
      app_replace_lefts_rights_style(rb, enabled);
      let on_b = app_replace_button_rule_background_color();
      let c = ternary_nested(selected, highlight, enabled, on_b, "#a8a8a8ff");
      html_style_background_color_set(rb, c);
      let arrow2 = property_get(rb, "arrow");
      html_style_font_color_set_if(enabled, arrow2, "black", "#6a6a6a");
    }
    each_index(rules_buttons, each_button_rule_refresh);
    html_clear(div_symbols);
    let sbs = null;
    function symbols_mapper(symbol, index) {
      let sb = null;
      async function symbol_on_click() {
        let rule2 = list_get(rules_parsed, index_selected);
        let eq = app_replace_rule_valid(rule2, index, current_list);
        if (eq) {
          symbols_invalid_chosen = {};
          let right = property_get(rule2, "right");
          let left = property_get(rule2, "left");
          let before = list_take(current_list, index);
          let size = list_size(left);
          let after = list_skip(current_list, index + size);
          current_list = list_concat_multiple([before, right, after]);
          let rb = list_get(rules_buttons, index_selected);
          let lefts2 = property_get(rb, "lefts");
          let rights2 = property_get(rb, "rights");
          let size3 = list_size(lefts2);
          let sliced2 = list_slice_count(sbs, index, size3);
          const sum = index + size3;
          let skipped = list_skip(sbs, sum);
          let rects_before = list_map(skipped, html_bounding_client_rect);
          const duration = 500;
          async function lambda6(a, b) {
            await html_move_animate(a, b, duration);
            html_parent_remove(a);
          }
          let mapped = list_map_pairs(sliced2, lefts2, lambda6);
          let v = await list_wait(mapped);
          await html_request_animation_frame();
          let rects_middle = list_map(skipped, html_bounding_client_rect);
          let rights_cloned = list_map(rights2, html_clone);
          function lambda8(item, index5) {
            html_visibility_hidden(item);
            html_insert(div_symbols, item, index + index5);
          }
          each_index(rights_cloned, lambda8);
          let rects_after = list_map(skipped, html_bounding_client_rect);
          async function lambda9([el, rect_before, rect_after]) {
            const dx = rect_before.left - rect_after.left;
            const dy = rect_before.top - rect_after.top;
            html_style_set(el, "transition", "transform 0ms");
            html_style_set(el, "transform", `translate(${dx}px, ${dy}px)`);
            el.offsetWidth;
            html_style_set(el, "transition", `transform ${duration}ms`);
            html_style_set(el, "transform", `translate(0px, 0px)`);
            log({});
            await sleep(duration);
            html_style_set(el, "transition", "");
            html_style_set(el, "transform", "");
          }
          await each_multiple_async(
            [skipped, rects_after, rects_middle],
            lambda9,
          );
          if (false) {
            async function lambda10(arg) {
              let [c, rect_middle, rect_after] = arg;
              const dx = rect_after.left - rect_middle.left;
              const dy = rect_after.top - rect_middle.top;
              const t = `translate(${dx}px, ${dy}px)`;
              html_style_set(c, "transform", t);
              c.offsetWidth;
              let a = {
                top: rect_after.top + dy,
                left: rect_after.left + dx,
              };
              let r3 = html_bounding_client_rect(c);
              await html_move_animate_rect(c, r3, a, duration);
            }
            await each_multiple_async(
              [skipped, rects_middle, rects_after],
              lambda10,
            );
          }
          return;
          index_selected = null;
        } else {
          property_set(symbols_invalid_chosen, index, true);
        }
        refresh();
      }
      sb = html_button(div_symbols, symbol, symbol_on_click);
      app_replace_button_symbol_style(sb);
      property_set_exists_not(sb, "index", index);
      let valid = false;
      let nn2 = null_not_is(index_selected);
      if (nn2) {
        let index3 = property_get(sb, "index");
        let rule2 = list_get(rules_parsed, index_selected);
        valid = app_replace_rule_valid(rule2, index3, current_list);
      }
      app_replace_button_symbol_style_valid(sb, index_selected !== null);
      let exists = property_exists(symbols_invalid_chosen, index);
      if (exists) {
        html_style_background_color_set(sb, "#D10000");
        app_replace_button_symbol_style_box_shadow(true, sb, "#FF8A8A");
      }
      return sb;
    }
    sbs = list_map_index(current_list, symbols_mapper);
    ("no success before?");
    if (not(success)) {
      ("goal satisfied?");
      let eq2 = json_equal(current_list, goal_list);
      if (eq2) {
        success = true;
        function lambda5(value) {
          let g = app_replace_rule_sets_data_goal(value, rule_name, goal);
          property_set(g, "completed", true);
          return value;
        }
        storage_local_transform_context(context, "rule_sets_data", {}, lambda5);
        let lambda4 = app_replace_button_symbol_style_valid_curry_right(true);
        each_nested([goal_list_symbols, sbs], lambda4);
        let choices = [
          emoji_trophy,
          emoji_100,
          emoji_clap,
          emoji_medal_star,
          emoji_medal_1,
          emoji_party_popper,
          emoji_party_face,
        ];
        const taken_count = 3;
        let taken = list_shuffle_take(choices, taken_count);
        list_add_first(taken, emoji_check);
        let mapped = list_map(taken, invoke);
        let joined = list_join_empty(mapped);
        let p = html_p(div_below);
        html_style_background_color_set(p, highlight);
        app_replace_button_symbol_style(p);
        html_centered(p);
        let emojis = html_div(p);
        html_span_text(emojis, joined);
        html_style_font_size(emojis, "1.5em");
        let p3 = html_div(p);
        const encouragements_choices = [
          "Congratulations",
          "Success",
          "Good job",
          "Well done",
        ];
        let encouragements = list_shuffle_take(encouragements_choices, 2);
        let p4 = html_div(p3);
        html_bold(p4);
        function lambda(encouragement) {
          html_span_text(p4, encouragement + "! ");
        }
        each(encouragements, lambda);
        let p_next = html_p(div_below);
        let goal_index_next = goal_index + 1;
        let ii = list_index_is(goals, goal_index_next);
        let rule_set_index = storage_local_get_context(
          context,
          "rule_set_index",
        );
        let rule_sets = app_replace_rule_sets();
        let rule_set_index_next = rule_set_index + 1;
        let ii2 = list_index_is(rule_sets, rule_set_index_next);
        let next = true;
        if (not(ii) && not(ii2)) {
          html_p_text_centered(
            p_next,
            "You have completed all goals that are available at this time!",
          );
        }
        function lambda2() {
          if (ii) {
            storage_local_set_context(context, "goal_index", goal_index_next);
          } else {
            if (ii2) {
              storage_local_set_context(
                context,
                "rule_set_index",
                rule_set_index_next,
              );
              storage_local_set_context(context, "goal_index", 0);
            } else {
              next = false;
            }
          }
          app_shared_screen_set(context, app_replace_rule_set);
        }
        let text = app_karate_button_next_text();
        let bn = app_replace_button(p_next, text, lambda2);
        html_width_full(bn);
      }
      let nn = null_not_is(index_selected);
      html_text_set_if(nn, "Rules:", "Choose a rule:", label_rules);
      html_text_set_if(nn, "Choose a symbol:", "Symbols:", label_symbols);
    }
  }
  refresh();
}
